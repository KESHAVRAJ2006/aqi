name: CD - Deploy to Kubernetes

on:
  push:
    branches: [ master ]

  workflow_run:
    workflows: ["AQI CI"]
    types:
      - completed

env:
  IMAGE: ${{ secrets.IMAGE_NAME }} 
  IMAGE_TAG: ${{ github.sha }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    # Create .kube directory
    - name: Create kube directory
      run: mkdir -p $HOME/.kube

    # Restore kubeconfig (fixed)
    - name: Restore kubeconfig
      env:
        KUBECONFIG_DATA: ${{ secrets.KUBECONFIG_DATA }}
      run: |
        echo "${KUBECONFIG_DATA}" | base64 --decode > $HOME/.kube/config
        chmod 600 $HOME/.kube/config
        kubectl config view     # âœ” FIXED (removed --minify)

    - name: Show cluster info
      run: kubectl cluster-info

    # Update image in deployment
    - name: Update image in Deployment
      run: |
        echo "Updating deployment image to ${IMAGE}:${IMAGE_TAG}"
        kubectl set image deployment/aqi-deploy aqi=${IMAGE}:${IMAGE_TAG} --record
        kubectl rollout status deployment/aqi-deploy --timeout=180s

    # Optional smoke test
    - name: Post-deploy smoke test
      run: |
        SERVICE_URL=$(kubectl get svc aqi-service -o jsonpath='{.spec.clusterIP}')
        echo "Service Cluster IP: $SERVICE_URL"

    - name: Notify on success
      run: echo "Deployment completed successfully!"
