name: Security Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  security:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # ---------- 1. Secret Leak Scanner ----------
    - name: Secret Scan (Gitleaks)
      uses: gitleaks/gitleaks-action@v2
      with:
        config-path: ""   # default rules
        verbose: true

    # ---------- 2. Python Dependency Vulnerability Scan ----------
    - name: Install dependencies
      run: pip install -r requirements.txt

    - name: Python Security Scan (pip-audit)
      run: pip install pip-audit && pip-audit

    # ---------- 3. Docker Image Security Scan ----------
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build Docker image
      run: docker build -t aqi-security-test .

    - name: Scan Docker Image (Trivy)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: "aqi-security-test"
        format: "table"
        exit-code: 1      # fail pipeline on high severity issues
        ignore-unfixed: true

    # ---------- 4. Kubernetes Manifest Security Scan ----------
    - name: K8s Security Scan (kube-score)
      uses: zegl/kube-score@main
      with:
        manifests: "k8s/*.yaml"

    # ---------- 5. Static Code Security Scan (SAST) ----------
    - name: Python SAST (Bandit)
      run: pip install bandit && bandit -r .
