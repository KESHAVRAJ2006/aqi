name: Security Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  security:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # ---- Secret leak checking ----
    - name: Secret Scan (Gitleaks)
      uses: gitleaks/gitleaks-action@v2
      with:
        verbose: true

    # ---- Python dependency CVE scan ----
    - name: Install dependencies
      run: pip install -r requirements.txt

    - name: Python Security Scan (pip-audit)
      run: pip install pip-audit && pip-audit

    # ---- Docker image vulnerability scanner ----
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build Docker image
      run: docker build -t aqi-security-test .

    - name: Scan Docker Image (Trivy)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: "aqi-security-test"
        format: "table"
        exit-code: 1
        ignore-unfixed: true

    # ---- Kubernetes manifest security scan (FIXED) ----
    - name: Install kube-score
      run: |
        curl -L https://github.com/zegl/kube-score/releases/latest/download/kube-score_ubuntu_amd64.tar.gz -o kube-score.tar.gz
        tar -xzf kube-score.tar.gz
        sudo mv kube-score /usr/local/bin/kube-score
        kube-score version

    - name: Run Kubernetes Security Scan
      run: kube-score score k8s/*.yaml

    # ---- App static code security ----
    - name: Python SAST (Bandit)
      run: pip install bandit && bandit -r .
